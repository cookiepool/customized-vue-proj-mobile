## 开始
本文章上接搭建篇，因为篇幅原因（实际是还没写完 #滑稽保命），我把优化单独放一篇文章来讲。

> []()

好了，废话不多讲，直接进入正题。

## 开始优化前做的一些事情

很多时候做开发都会使用UI组件库，这些组件库一般都会有按需加载的功能，这里我选择vant组件库来测试。手头暂时没有可以演示的项目，可能有点纯理论感觉，但是应该能大家一个优化的思路。我会在测试项目里面写一些测试页面，到时上传到github供大家参考！

- 注意：
经过我前面的一些实践，这儿有事情需要告知
> 1、如果开发环境和生产环境都使用插件把CSS分离出来成为单独的文件，那么你在开发过程中会发现热更新对CSS不生效，所以解决方法就是分离CSS仅配置在生产环境。给大家埋了个坑！

## 开始
### 1、组件库按需加载
安装vant
```
npm install vant
```
安装完毕后，我们先使用官网的全局导入所有组件
- 全局导入所有组件
```
import Vant from 'vant';
import 'vant/lib/index.css';

Vue.use(Vant);
```
然后你到页面使用几个组件，比如Button，Dialog这些，运行npm run dev命令，这时发现报错了，说Module parse failed: Unexpected character '@'，这是因为我们引入vant时，引入了css文件，但是我们的webpack并没有配置处理css的loader，所以加上即可：
```
{
  test: /\.css$/,
  // 这儿组件库的css一般都是处理过的，我们使用一般的loader即可
  use: [
    {
      loader: 'style-loader',
    },
    {
      loader: 'css-loader',
    }
  ]
}
```
这样我们就能运行并加入相关组件了，这里我们不演示组件使用，而是直接打包展示结果分析图：

![1.png](https://i.loli.net/2019/12/13/sdIYrT7SR5blZ4L.png)

我们可以看见那个硕大的index.css，也就是说你没用到的组件它也把样式这些都弄进来了。

- 按需加载
使用按需加载需要使用到一个插件叫babel-plugin-import。
```
npm install babel-plugin-import -D
```
安装完毕后在babel.config.js里面配置：
```
// 按需加载vant组件
plugins: [
  ["import", {
    libraryName: 'vant',
    libraryDirectory: 'es',
    style: true
  }, 'vant']
]
```
这样你在main.js里面这样引入即可：
```
// 按需注册vant组件
import { Button } from 'vant';
Vue.use(Button);
```
你使用了什么组件就注册什么组件，目前社区上的许多ui组件库都是支持按需加载的，有的话一定要使用这种方式。

![2.png](https://i.loli.net/2019/12/13/rTtWSG8m36yFgH2.png)

这下看下，比刚才全部引入好多了，额。。main.js硕大应该是未分离所有东西打包到一起的原因-_-!。

### 2、路由懒加载
使用路由懒加载，在页面访问到是再加载对应的资源，提升首页访问的速度。
在这之前，我们还需要一个babel插件来实现这个功能
```
npm install @babel/plugin-syntax-dynamic-import -D
```
安装完毕后，在webpack里面babel-loader配置加上以下代码：
```
{
  test: /\.jsx?$/,
  exclude: /node_modules/,
  use: [
    {
      loader: 'babel-loader',
      options: {
        // 使用vue官方的懒加载语法并结合babel需使用这个插件，不然会报错
        plugins: ["@babel/plugin-syntax-dynamic-import"]
      }
    }	
  ]
}
```
然后我们现有的路由里面引入组件的写法需要改变下，比如你现在是这么写的：
```
import Home from '../views/Home.vue';
import RouterTest from '../views/RouterTest.vue';
import VantTest from '../views/VantTest.vue';
```
改成下面的写法：
```
//官方的懒加载方案，需要在webpack.config.js中配置@babel/plugin-syntax-dynamic-import这个插件，否则babel不支持以下语法会报错。
//下面的注释语法是打包生成的js的文件名，如果你想某几个组件打包到同一个文件，那么它们的注释语法的webpackChunkName的名字相同即可
const MainPage = () =>
  import(/* webpackChunkName: "group-foo" */ "./views/MainPage.vue");
const ComOne = () =>
  import(/* webpackChunkName: "group-foo" */ "./views/ComOne.vue");
const ComTwo = () =>
  import(/* webpackChunkName: "group-foo" */ "./views/ComTwo.vue");
```
这样处理后你会发现你在切换路由时会加载额外的js文件，这样我们就分离了出来按需加载，打包分析图如下：

![3.png](https://i.loli.net/2019/12/13/Tf4RPQ2IabFqhks.png)

这里可以发现一个问题，我们很多包都重复打了，接下来就是去除重复打包。所以我们要提取公共代码。

在webpack3的时候，我们可以借助CommonsChunkPlugin来实现，webpack4已经移除了这个插件，在webpack4中可以用splitChunks来实现。
